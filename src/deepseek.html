<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>æ‚¨çš„å¥åº·AIåŠ©æ‰‹</title>
  
  <!-- Viewport & color scheme è§†å£ä¸é¢œè‰²æ–¹æ¡ˆ -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="color-scheme" content="light dark" />
  <meta name="theme-color" content="#ffffff" />
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#121212" />

  <!-- Stylesheets æ ·å¼è¡¨ -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs/themes/prism.css">
  <link rel="stylesheet" href="../statics/css/deepseek.css" />

  <!-- Third-party libs å¤–éƒ¨åº“ï¼ˆdefer é¿å…é˜»å¡æ¸²æŸ“ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs/prism.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs/components/prism-python.min.js" defer></script>
</head>

<body>
  <!-- Header é¡µå¤´ -->
  <header>æ‚¨çš„å¥åº·AIåŠ©æ‰‹</header>

  <!-- Chat container èŠå¤©å®¹å™¨ -->
  <div class="chat-container">
    <!-- Message list æ¶ˆæ¯åˆ—è¡¨ï¼šä½¿ç”¨å¯è®¿é—®æ€§è¯­ä¹‰ -->
    <div class="message-list" id="messageList" role="log" aria-live="polite" aria-relevant="additions"></div>

    <!-- Input area è¾“å…¥åŒº -->
    <div class="input-container">
      <input
        type="text"
        id="userInput"
        placeholder="è¯·è¾“å…¥ä½ çš„æ¶ˆæ¯..."
        autocomplete="off"
        enterkeyhint="send"
        aria-label="è¾“å…¥ä½ çš„æ¶ˆæ¯"
        onkeydown="if(event.key === 'Enter') sendMessage()"
      />
      <button type="button" id="sendBtn" onclick="sendMessage()" aria-label="å‘é€æ¶ˆæ¯">å‘é€</button>
    </div>
  </div>

  <script>
    // Wait for deferred libs ç­‰ç¬¬ä¸‰æ–¹åº“åŠ è½½å®Œæˆ
    window.addEventListener('DOMContentLoaded', () => {
      // marked config: soft line breaks & safer defaults
      if (window.marked) {
        marked.setOptions({ breaks: true, mangle: false, headerIds: false });
      }
      generateGreeting();
    });

    /**
     * Sanitize + render Markdown å®‰å…¨æ¸²æŸ“ Markdown
     * - ä½¿ç”¨ DOMPurify è¿›è¡Œ XSS è¿‡æ»¤
     */
    function renderMarkdownSafe(mdText) {
      const html = (window.marked ? marked.parse(mdText || '') : (mdText || ''));
      return window.DOMPurify ? DOMPurify.sanitize(html, { USE_PROFILES: { html: true } }) : html;
    }

    // åˆå§‹é—®å€™
    function generateGreeting() {
      const hour = new Date().getHours();
      let greet = 'æ‚¨å¥½ï¼æœ‰ä»€ä¹ˆå¥åº·é—®é¢˜å°½ç®¡é—®æˆ‘å“¦~';
      if (hour >= 5 && hour < 11) greet = 'æ—©ä¸Šå¥½ â˜€ï¸ï¼Œæˆ‘å¯ä»¥å¸®ä½ åˆ†æé¥®é£Ÿã€ä½œæ¯æˆ–ä½“æ£€æŠ¥å‘Šã€‚';
      else if (hour < 14) greet = 'ä¸­åˆå¥½ ğŸµï¼Œæ³¨æ„è¡¥æ°´ï¼Œæœ‰ä»€ä¹ˆæƒ³é—®çš„ï¼Ÿ';
      else if (hour < 18) greet = 'ä¸‹åˆå¥½ ğŸŒ¿ï¼Œéœ€è¦æˆ‘çœ‹çœ‹ä½ çš„è®­ç»ƒ/é¥®é£Ÿè®¡åˆ’å—ï¼Ÿ';
      else greet = 'æ™šä¸Šå¥½ ğŸŒ™ï¼Œä»Šå¤©æ„Ÿè§‰æ€ä¹ˆæ ·ï¼Ÿæˆ‘å¯ä»¥å¸®ä½ åšä¸ªæ€»ç»“ã€‚';
      addMessage(greet, 'bot');
    }

    // æ‰“å­—ä¸­å ä½æ°”æ³¡ typing bubble
    function addTypingBubble() {
      const msgList = document.getElementById('messageList');
      const wrap = document.createElement('div');
      wrap.className = 'message bot typing';
      wrap.setAttribute('aria-label', 'æ­£åœ¨å›å¤');
      wrap.innerHTML = '<span class="dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>';
      msgList.appendChild(wrap);
      msgList.scrollTop = msgList.scrollHeight;
      return wrap;
    }

    async function sendMessage() {
      const inputEl = document.getElementById('userInput');
      const btn = document.getElementById('sendBtn');
      const message = inputEl.value.trim();
      if (!message) return;

      inputEl.disabled = true;
      btn.disabled = true;

      addMessage(message, 'user');
      inputEl.value = '';

      const thinkingMsg = addTypingBubble();

      try {
        const response = await fetch('https://zhucan.xyz:5000/deepseek/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });

        const data = await response.json().catch(() => ({}));
        if (response.ok && data && typeof data.reply === 'string') {
          thinkingMsg.classList.remove('typing');
          thinkingMsg.innerHTML = renderMarkdownSafe(data.reply);
          if (window.Prism) Prism.highlightAll();
        } else {
          thinkingMsg.classList.remove('typing');
          thinkingMsg.textContent = 'âŒ å‡ºé”™äº†ï¼š' + (data.error || response.status + ' ' + response.statusText);
        }
      } catch (error) {
        thinkingMsg.classList.remove('typing');
        thinkingMsg.textContent = 'âš ï¸ æ— æ³•è¿æ¥æœåŠ¡å™¨ï¼š' + (error && error.message ? error.message : 'Network error');
      } finally {
        inputEl.disabled = false;
        btn.disabled = false;
        inputEl.focus();
      }
    }

    // æ·»åŠ æ¶ˆæ¯åˆ°åˆ—è¡¨
    function addMessage(text, sender, returnElement = false) {
      const msgList = document.getElementById('messageList');
      const msgDiv = document.createElement('div');
      msgDiv.className = 'message ' + sender;
      const content = document.createElement('div');
      content.className = 'msg-content';

      if (sender === 'bot') {
        content.innerHTML = renderMarkdownSafe(text);
      } else {
        // User text as plain text to avoid injection ç”¨æˆ·æ¶ˆæ¯æŒ‰çº¯æ–‡æœ¬æ’å…¥
        content.textContent = text;
      }

      msgDiv.appendChild(content);
      msgList.appendChild(msgDiv);
      msgList.scrollTop = msgList.scrollHeight;
      if (window.Prism) Prism.highlightAll();
      return returnElement ? msgDiv : undefined;
    }
  </script>
</body>
</html>